{% extends 'base.html' %}
{% load static %}

{% block title %}AI Academy - Mechatronics Hub{% endblock %}

{% block content %}
<!-- External Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<div
    class="flex h-[calc(100vh-80px)] overflow-hidden bg-white/20 dark:bg-[#131314] text-charcoal dark:text-[#e3e3e3] font-sans transition-colors duration-300 backdrop-blur-md">

    <!-- Gemini Sidebar -->
    <aside id="aiSidebar"
        class="w-0 overflow-hidden md:relative bg-white/70 dark:bg-[#0b0c0d] flex-shrink-0 flex flex-col transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute h-full z-40 border-r border-gray-200/50 dark:border-[#1e1f20] backdrop-blur-xl">

        <!-- New Chat Button -->
        <div class="p-4 mt-2">
            <a href="{% url 'hub:ai_assistant' %}"
                class="flex items-center justify-center space-x-2 px-4 py-3 bg-white dark:bg-[#1a1b1e] hover:bg-gray-50 dark:hover:bg-[#25262a] text-forest-green dark:text-emerald-400 rounded-2xl transition-all duration-300 group border border-gray-200/50 dark:border-white/5 shadow-md hover:shadow-lg active:scale-[0.98]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path>
                </svg>
                <span class="text-sm font-bold tracking-tight">New chat</span>
            </a>
        </div>

        <!-- Recent Chats List -->
        <div class="flex-1 overflow-y-auto px-3 py-2 custom-scrollbar">
            <h3 class="text-[11px] font-bold text-[#5e5f61] px-3 mb-3 uppercase tracking-widest mt-2">Recent</h3>
            <div class="space-y-0.5">
                {% for session in sessions %}
                <div
                    class="group relative flex items-center rounded-xl transition-all duration-200 mx-1 {% if active_session.id == session.id %}bg-white/80 dark:bg-[#1e1f20] shadow-sm ring-1 ring-gray-200/50 dark:ring-white/5{% else %}hover:bg-white/50 dark:hover:bg-[#1a1b1e]/50{% endif %}">
                    <a href="{% url 'hub:ai_assistant' %}?session={{ session.id }}"
                        class="flex items-center flex-1 px-3 py-2.5 text-[13px] truncate text-charcoal/80 dark:text-[#e3e3e3] pr-10"
                        title="{{ session.title }}">
                        <svg class="w-4 h-4 mr-3 flex-shrink-0 text-charcoal/40 dark:text-gray-500 group-hover:text-forest-green dark:group-hover:text-[#8ab4f8] transition-colors"
                            fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                        <span
                            class="truncate {% if active_session.id == session.id %}font-bold text-forest-green dark:text-[#8ab4f8]{% endif %}">
                            {{ session.title }}
                        </span>
                    </a>

                    <!-- Delete Action -->
                    <button onclick="deleteSession('{{ session.id }}'); event.preventDefault();"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg text-charcoal/40 dark:text-[#5e5f61] hover:text-red-500 dark:hover:text-[#ff8b8b] hover:bg-red-50 dark:hover:bg-red-900/20 opacity-0 group-hover:opacity-100 transition-all duration-200 z-10"
                        title="Delete Chat">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <p class="text-xs text-[#5e5f61] italic">No recent history</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Help and Settings sections removed -->
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col relative h-full min-w-0 transition-all duration-300">
        <!-- Floating Menu Toggle (Mobile & Desktop) -->
        <button id="sidebarToggle"
            class="absolute top-4 left-4 z-50 p-2 bg-white/50 dark:bg-[#1e1f20]/50 hover:bg-white dark:hover:bg-[#1e1f20] border border-gray-200 dark:border-transparent rounded-lg text-charcoal dark:text-white transition-colors backdrop-blur-sm shadow-sm">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
        </button>

        <!-- Landing State -->
        <div id="landingState"
            class="{% if chat_messages or active_session %}hidden{% else %}flex{% endif %} flex-1 flex-col items-center justify-start p-6 text-center max-w-4xl mx-auto w-full pt-4 md:pt-8">
            <div class="mb-8 animate-sparkle">
                <svg class="w-16 h-16 text-[#8ab4f8]" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                </svg>
            </div>
            <h1
                class="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-[#4285f4] via-[#9b72cb] to-[#d96570] text-transparent bg-clip-text">
                <span class="lang-en">ğŸ‘‹ Welcome!</span>
                <span class="lang-ar">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</span>
            </h1>
            <div class="text-charcoal dark:text-[#c4c7c5] mb-8 max-w-2xl text-center">
                <p class="text-lg md:text-xl mb-6">
                    <span class="lang-en">I'm the Academic Assistant for the Mechatronics Department, Faculty of
                        Engineering.</span>
                    <span class="lang-ar">Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„Ù‚Ø³Ù… Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ÙŠÙƒØ§ØªØ±ÙˆÙ†ÙƒØ³ØŒ ÙƒÙ„ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©.</span>
                </p>
                <div class="inline-block text-left space-y-2 mb-6">
                    <p class="font-medium text-charcoal/80 dark:text-white/80">
                        <span class="lang-en">I can help you with:</span>
                        <span class="lang-ar">ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:</span>
                    </p>
                    <ul class="space-y-1.5">
                        <li class="flex items-center space-x-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#4285f4]"></span>
                            <span>
                                <span class="lang-en">Registration and requirements</span>
                                <span class="lang-ar">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª</span>
                            </span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#9b72cb]"></span>
                            <span>
                                <span class="lang-en">Courses and credit hours</span>
                                <span class="lang-ar">Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</span>
                            </span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#d96570]"></span>
                            <span>
                                <span class="lang-en">Study and exam tips</span>
                                <span class="lang-ar">Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</span>
                            </span>
                        </li>
                    </ul>
                </div>
                <p class="text-charcoal/90 dark:text-white/90 font-medium">
                    <span class="lang-en">Feel free to ask me anything! ğŸ‘Œ</span>
                    <span class="lang-ar">Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø³Ø¤Ø§Ù„ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡! ğŸ‘Œ</span>
                </p>
            </div>

        </div>

        <!-- Messages Area -->
        <div id="chatMessages"
            class="{% if not chat_messages and not active_session %}hidden{% endif %} flex-1 overflow-y-auto pt-16 pb-64 md:pb-48 px-4 md:px-0 custom-scrollbar">
            <div class="max-w-3xl mx-auto space-y-12">
                {% for msg in chat_messages %}
                <div class="chat-message-container" data-role="{{ msg.role }}" data-content="{{ msg.content }}">
                    <!-- JS will render this -->
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden absolute bottom-64 md:bottom-40 left-0 right-0 z-20">
            <div class="max-w-3xl mx-auto flex items-start space-x-4 px-4 md:px-0">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-[#4285f4] to-[#9b72cb] flex items-center justify-center animate-spin">
                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path>
                    </svg>
                </div>
                <div class="flex-1 space-y-2 pt-2">
                    <div class="h-4 bg-gray-200 dark:bg-white/5 rounded w-3/4 animate-pulse"></div>
                    <div class="h-4 bg-gray-200 dark:bg-white/5 rounded w-1/2 animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Sticky Input Area -->
        <div id="inputArea"
            class="absolute bottom-20 md:bottom-0 left-0 right-0 bg-transparent pt-10 pb-6 px-4 transition-transform duration-300 ease-in-out z-30 transform-gpu">
            <div class="max-w-3xl mx-auto relative group">
                <form id="chatForm"
                    class="flex flex-col bg-white/80 dark:bg-[#1e1f20] hover:bg-white dark:hover:bg-[#28292a] border border-gray-300 dark:border-transparent focus-within:border-forest-green/40 dark:focus-within:border-white/10 rounded-[32px] transition-all overflow-hidden shadow-2xl backdrop-blur-2xl">
                    {% csrf_token %}
                    <input type="hidden" name="session_id" id="session_id" value="{{ active_session.id|default:'' }}">

                    <div class="flex flex-col w-full">
                        <div class="flex items-end px-6 py-3 space-x-3">
                            <textarea id="messageInput" rows="1" placeholder="Search the Student Handbook..."
                                class="flex-1 bg-transparent border-0 focus:ring-0 outline-none text-charcoal dark:text-white placeholder-charcoal/50 dark:placeholder-gray-500 resize-none py-1.5 text-base overflow-y-auto max-h-40 custom-scrollbar"></textarea>

                            <div class="flex items-center space-x-1.5 pb-0.5">
                                <button type="submit" id="sendBtn"
                                    class="p-2.5 bg-[#4285f4] text-white rounded-full hover:bg-[#3b77db] disabled:opacity-50 disabled:bg-gray-700 transition-all transform active:scale-95 shadow-lg group">
                                    <svg class="w-5 h-5 group-disabled:hidden" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    <div
                                        class="hidden group-disabled:block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin">
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                <p class="text-[10px] text-charcoal/60 dark:text-gray-500 text-center mt-3 tracking-wide">
                    Strict Retrieval Mode: Answers are sourced directly from the Zagazig National University Handbook.
                </p>
            </div>
        </div>
    </main>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', sans-serif;
        overflow: hidden;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes sparkle {

        0%,
        100% {
            transform: scale(1) rotate(0deg);
            filter: drop-shadow(0 0 0px #4285f4);
        }

        50% {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 15px #4285f4);
        }
    }

    .animate-sparkle {
        animation: sparkle 4s infinite ease-in-out;
    }

    /* Markdown Styling */
    .markdown-content {
        font-family: 'Inter', 'IBM Plex Sans Arabic', sans-serif;
    }

    .markdown-content h1 {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        color: #fff;
        background: linear-gradient(to right, #4285f4, #9b72cb);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .markdown-content h2 {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 1.25rem 0 0.75rem;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
        line-height: 1.7;
    }

    .markdown-content strong {
        color: #8ab4f8;
        font-weight: 600;
    }

    .markdown-content ul,
    .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content code {
        background: rgba(0, 0, 0, 0.05);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: monospace;
    }

    .dark .markdown-content code {
        background: rgba(255, 255, 255, 0.08);
    }

    .markdown-content pre {
        background: #f8fafc !important;
        padding: 1rem;
        border-radius: 12px;
        overflow-x: auto;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dark .markdown-content pre {
        background: #0d0d0d !important;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Answer Card Styling */
    .answer-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(32px);
        -webkit-backdrop-filter: blur(32px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 24px;
        padding: 1.75rem !important;
        margin-top: 0.5rem;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        width: 100%;
        color: #111111;
    }

    .dark .answer-card {
        background: rgba(30, 31, 32, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        color: #e3e3e3;
    }

    .metadata-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.85rem;
        background: rgba(66, 133, 244, 0.1);
        color: #1a73e8;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.6rem;
        border: 1px solid rgba(66, 133, 244, 0.2);
    }

    .dark .metadata-chip {
        background: rgba(66, 133, 244, 0.12);
        color: #8ab4f8;
        border: 1px solid rgba(66, 133, 244, 0.25);
    }

    .related-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.6rem 1.1rem;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #1a1a1a;
        border-radius: 14px;
        font-size: 0.85rem;
        margin-right: 0.6rem;
        margin-top: 0.6rem;
        cursor: pointer;
        transition: all 0.2s;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .related-chip:hover {
        background: rgba(255, 255, 255, 0.9);
        color: #000000;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .dark .related-chip {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #c4c7c5;
    }

    .dark .related-chip:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
    }

    [dir="rtl"] .metadata-chip {
        margin-right: 0;
        margin-left: 0.5rem;
    }

    [dir="rtl"] .related-chip {
        margin-right: 0;
        margin-left: 0.6rem;
    }

    .markdown-content pre code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        font-size: 0.85em;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid rgba(0, 0, 0, 0.06);
        padding: 0.75rem;
        text-align: left;
    }

    .dark .markdown-content th,
    .dark .markdown-content td {
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .markdown-content th {
        background: rgba(0, 0, 0, 0.02);
    }

    .dark .markdown-content th {
        background: rgba(255, 255, 255, 0.05);
    }

    .markdown-content blockquote {
        border-left: 4px solid #4285f4;
        padding-left: 1rem;
        font-style: italic;
        color: #6b7280;
        margin: 1rem 0;
    }

    .dark .markdown-content blockquote {
        color: #a3a3a3;
    }
</style>

<script>
    (function () {
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const landingState = document.getElementById('landingState');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const aiSidebar = document.getElementById('aiSidebar');
        const sidebar = aiSidebar; // For compatibility with updateSidebarState
        const sessionIdInput = document.getElementById('session_id');
        const isMobile = () => window.innerWidth < 1024;
        let isSidebarOpen = false;

        // Initialize Markdown and Highlight.js
        marked.setOptions({
            highlight: function (code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Render existing messages
        document.querySelectorAll('.markdown-content').forEach(el => {
            el.innerHTML = marked.parse(el.textContent.trim());
        });

        // Sidebar Logic
        sidebarToggle.addEventListener('click', () => {
            isSidebarOpen = !isSidebarOpen;
            updateSidebarState();
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        async function sendMessage(text = null) {
            const message = text || messageInput.value.trim();
            if (!message) return;

            // Handle Landing State UI
            if (landingState && !landingState.classList.contains('hidden')) {
                landingState.classList.add('hidden');
                chatMessages.classList.remove('hidden');
            }

            const userMsgEl = createMessageElement('user', message);
            const container = chatMessages.querySelector('.max-w-3xl');
            if (container) container.appendChild(userMsgEl);

            if (!text) {
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }

            const sendBtn = document.getElementById('sendBtn');
            messageInput.disabled = true;
            sendBtn.disabled = true;
            scrollToBottom();

            loadingIndicator.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('message', message);
                formData.append('session_id', sessionIdInput.value || '');
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('{% url "hub:ai_assistant" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                loadingIndicator.classList.add('hidden');

                if (data.success) {
                    if (!sessionIdInput.value && data.session_id) {
                        sessionIdInput.value = data.session_id;
                        window.history.pushState({}, '', `?session=${data.session_id}`);
                    }

                    const aiMsgEl = createMessageElement('model', data.response);
                    if (container) container.appendChild(aiMsgEl);
                    scrollToElement(aiMsgEl);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                console.error('Communication error:', error);
            } finally {
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        window.submitRelatedQuestion = function (text) {
            sendMessage(text);
        };

        // Handle Enter to submit (Shift+Enter for newline)
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.scrollToBottom = function () {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        };

        window.scrollToElement = function (el) {
            if (!el) return;
            // Scroll to the element's position minus some margin for the header
            const target = el.offsetTop - 80;
            chatMessages.scrollTo({
                top: target,
                behavior: 'smooth'
            });
        };

        // Scroll to bottom on load
        scrollToBottom();

        window.prefillInput = function (text) {
            messageInput.value = text;
            messageInput.dispatchEvent(new Event('input'));
            messageInput.focus();
        };

        window.deleteSession = async function (id) {
            if (!confirm('Delete this conversation?')) return;
            try {
                const response = await fetch(`/ai-assistant/delete/${id}/`);
                if (response.ok) window.location.href = '{% url "hub:ai_assistant" %}';
            } catch (e) {
                alert('Failed to delete');
            }
        };

        function createMessageElement(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'items-start space-x-4 animate-fadeIn'}`;

            let displayContent = content;
            let metadataHtml = '';
            let relatedHtml = '';

            // Try to parse JSON for AI responses
            if (role === 'model') {
                try {
                    const data = (typeof content === 'string' && (content.startsWith('{') || content.startsWith('[')))
                        ? JSON.parse(content)
                        : content;

                    if (data && typeof data === 'object' && data.answer) {
                        displayContent = data.answer;

                        if (data.metadata) {
                            if (data.metadata.course) metadataHtml += `<span class="metadata-chip">${data.metadata.course}</span>`;
                            if (data.metadata.program) metadataHtml += `<span class="metadata-chip">${data.metadata.program}</span>`;
                            if (data.metadata.level !== undefined && data.metadata.level !== null) metadataHtml += `<span class="metadata-chip">Level ${data.metadata.level}</span>`;
                        }

                        if (data.related_questions && data.related_questions.length > 0) {
                            relatedHtml = `<div class="mt-6 border-t border-white/5 pt-4">
                                <p class="text-xs text-gray-500 mb-2 uppercase tracking-widest font-bold">Related Questions</p>
                                <div class="flex flex-wrap">
                                    ${data.related_questions.map(q => `<div class="related-chip" onclick="submitRelatedQuestion('${q.replace(/'/g, "\\'")}');">${q}</div>`).join('')}
                                </div>
                            </div>`;
                        }
                    } else {
                        displayContent = content;
                    }
                } catch (e) {
                    displayContent = content;
                }
            }

            const isRtl = /[\u0600-\u06FF]/.test(displayContent);

            const innerHTML = role === 'user'
                ? `<div class="bg-white/70 dark:bg-[#2b2c2e] text-charcoal dark:text-white px-6 py-3 rounded-[28px] max-w-[80%] markdown-content border border-gray-300 dark:border-transparent shadow-md backdrop-blur-xl" ${isRtl ? 'dir="rtl"' : ''}>${escapeHtml(displayContent)}</div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-[#4285f4] to-[#9b72cb] flex items-center justify-center flex-shrink-0 mt-1 shadow-lg">
                    <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"></path></svg>
                   </div>
                   <div class="flex-1 max-w-full">
                       <div class="answer-card markdown-content" ${isRtl ? 'dir="rtl"' : ''}>
                           <div class="mb-4">${metadataHtml}</div>
                           <div class="prose dark:prose-invert max-w-none text-gray-800 dark:text-[#e3e3e3]">${marked.parse(displayContent)}</div>
                           ${relatedHtml}
                       </div>
                   </div>`;

            div.innerHTML = innerHTML;

            // Highlight code blocks
            if (role === 'model') {
                setTimeout(() => {
                    div.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }, 0);
            }

            return div;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize messages on load
        document.querySelectorAll('.chat-message-container').forEach(container => {
            const role = container.dataset.role;
            const content = container.dataset.content;
            container.appendChild(createMessageElement(role, content));
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        // Auto-hide input area on scroll (Mobile only)
        let isScrolling;
        const inputArea = document.getElementById('inputArea');

        chatMessages.addEventListener('scroll', () => {
            if (isMobile()) {
                inputArea.style.transform = 'translateY(150%)';
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(() => {
                    inputArea.style.transform = 'translateY(0)';
                }, 250);
            }
        }, { passive: true });

        function updateSidebarState() {
            if (isMobile()) {
                // Mobile behavior: Slide in/out
                sidebar.classList.remove('w-64', 'w-0', 'border-none'); // Reset desktop classes
                sidebar.style.width = ''; // Reset inline width

                if (isSidebarOpen) {
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    sidebar.classList.add('-translate-x-full');
                }
            } else {
                // Desktop behavior: Collapse width
                sidebar.classList.remove('-translate-x-full'); // Reset mobile transform

                if (isSidebarOpen) {
                    sidebar.classList.add('w-64', 'border-r');
                    sidebar.classList.remove('w-0', 'border-none', 'overflow-hidden');
                    sidebar.style.width = ''; // Let class handle it
                } else {
                    sidebar.classList.remove('w-64', 'border-r');
                    sidebar.classList.add('w-0', 'border-none', 'overflow-hidden');
                    sidebar.style.width = '';
                }
            }
        }

        // Initial state update
        updateSidebarState();
    })();
</script>
{% endblock %}